<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengelola Waktu Anak - Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen p-4 pb-20">
    <div class="max-w-4xl mx-auto">
        <div class="text-center text-white mb-6 pt-2">
            <h1 class="text-3xl font-bold mb-2">‚è∞ Pengelola Waktu Anak</h1>
            <p class="text-sm opacity-90">üîÑ Complete Edition - Realtime Sync</p>
        </div>

        <!-- Setup Firebase -->
        <div id="setupSection" class="bg-white rounded-2xl shadow-lg p-5 mb-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">üîë Setup Firebase</h2>
            <div class="space-y-3">
                <input type="text" id="apiKey" placeholder="API Key" 
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500">
                <input type="text" id="authDomain" placeholder="Auth Domain" 
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500">
                <input type="text" id="databaseURL" placeholder="Database URL" 
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500">
                <input type="text" id="projectId" placeholder="Project ID" 
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500">
                <button onclick="app.saveFirebaseConfig()" 
                    class="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition font-semibold">
                    üíæ Simpan & Mulai
                </button>
            </div>
        </div>

        <!-- Auth Loading -->
        <div id="authLoadingSection" style="display: none;" class="bg-white rounded-2xl shadow-lg p-8 mb-4 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <h2 class="text-lg font-semibold text-gray-800">üîê Mengamankan Aplikasi...</h2>
            <p class="text-sm text-gray-600 mt-2">Sedang setup authentication</p>
        </div>

        <!-- PIN Setup -->
        <div id="pinSetupSection" style="display: none;" class="bg-white rounded-2xl shadow-lg p-5 mb-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">üîê Buat PIN Orang Tua</h2>
            <p class="text-sm text-gray-600 mb-3">PIN untuk proteksi agar anak tidak bisa ubah data sendiri</p>
            <div class="space-y-3">
                <input type="password" id="newPin" placeholder="Buat PIN (4-6 digit)" maxlength="6"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-base focus:outline-none focus:border-indigo-500">
                <input type="password" id="confirmPin" placeholder="Konfirmasi PIN" maxlength="6"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-base focus:outline-none focus:border-indigo-500">
                <button onclick="app.setupPin()" 
                    class="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition font-semibold">
                    ‚úÖ Buat PIN
                </button>
                <button onclick="app.skipPin()" 
                    class="w-full bg-gray-400 text-white py-2 rounded-xl hover:bg-gray-500 transition text-sm">
                    Skip (Tidak Pakai PIN)
                </button>
            </div>
        </div>

        <!-- PIN Lock -->
        <div id="pinLockSection" style="display: none;" class="bg-white rounded-2xl shadow-lg p-5 mb-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-3 text-center">üîí Masukkan PIN Orang Tua</h2>
            <div class="space-y-3">
                <input type="password" id="enterPin" placeholder="Masukkan PIN" maxlength="6"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-base text-center text-2xl focus:outline-none focus:border-indigo-500">
                <button onclick="app.verifyPin()" 
                    class="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition font-semibold">
                    üîì Buka
                </button>
            </div>
        </div>

        <!-- Main App -->
        <div id="appSection" style="display: none;">
            <!-- Navigation Tabs -->
            <div class="bg-white rounded-2xl shadow-lg p-2 mb-4 flex gap-2 overflow-x-auto">
                <button onclick="app.switchTab('dashboard')" id="tab-dashboard"
                    class="flex-1 py-3 rounded-xl font-semibold transition bg-indigo-600 text-white whitespace-nowrap">
                    üìä Dashboard
                </button>
                <button onclick="app.switchTab('analytics')" id="tab-analytics"
                    class="flex-1 py-3 rounded-xl font-semibold transition text-gray-600 hover:bg-gray-100 whitespace-nowrap">
                    üìà Statistik
                </button>
                <button onclick="app.switchTab('schedule')" id="tab-schedule"
                    class="flex-1 py-3 rounded-xl font-semibold transition text-gray-600 hover:bg-gray-100 whitespace-nowrap">
                    üìÖ Jadwal
                </button>
                <button onclick="app.switchTab('tasks')" id="tab-tasks"
                    class="flex-1 py-3 rounded-xl font-semibold transition text-gray-600 hover:bg-gray-100 whitespace-nowrap">
                    ‚úÖ Aktivitas
                </button>
                <button onclick="app.switchTab('manage')" id="tab-manage"
                    class="flex-1 py-3 rounded-xl font-semibold transition text-gray-600 hover:bg-gray-100 whitespace-nowrap">
                    ‚öôÔ∏è Kelola
                </button>
                <button onclick="app.switchTab('history')" id="tab-history"
                    class="flex-1 py-3 rounded-xl font-semibold transition text-gray-600 hover:bg-gray-100 whitespace-nowrap">
                    üìú Riwayat
                </button>
                <button onclick="app.switchTab('settings')" id="tab-settings"
                    class="flex-1 py-3 rounded-xl font-semibold transition text-gray-600 hover:bg-gray-100 whitespace-nowrap">
                    ‚öôÔ∏è Pengaturan
                </button>
            </div>

            <!-- Dashboard Tab -->
            <div id="content-dashboard">
                <div id="dashboardContent"></div>
            </div>

            <!-- Analytics Tab -->
            <div id="content-analytics" style="display: none;">
                <div id="analyticsContent"></div>
            </div>

            <!-- Schedule Tab -->
            <div id="content-schedule" style="display: none;">
                <div id="scheduleContent"></div>
            </div>

            <!-- Tasks Tab -->
            <div id="content-tasks" style="display: none;">
                <div id="tasksContent"></div>
            </div>

            <!-- Manage Tab -->
            <div id="content-manage" style="display: none;">
                <div class="bg-white rounded-2xl shadow-lg p-5 mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3">‚ûï Tambah Anak Baru</h2>
                    <div class="space-y-3">
                        <input type="text" id="newChildName" placeholder="Nama anak..." 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-base focus:outline-none focus:border-indigo-500">
                        <input type="color" id="newChildColor" value="#667eea"
                            class="w-full h-12 border-2 border-gray-200 rounded-xl cursor-pointer">
                        <label class="text-sm text-gray-600">Pilih warna tema untuk anak ini</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm text-gray-600 block mb-1">Target Waktu Harian (menit)</label>
                                <input type="number" id="newChildTarget" value="60" min="0"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl text-base focus:outline-none focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="text-sm text-gray-600 block mb-1">Reward per Target (Rp)</label>
                                <input type="number" id="newChildReward" value="5000" min="0" step="1000"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl text-base focus:outline-none focus:border-indigo-500">
                            </div>
                        </div>
                        <button onclick="app.addChild()" 
                            class="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition font-semibold">
                            Tambah Anak
                        </button>
                    </div>
                </div>

                <div id="childrenManageList"></div>
            </div>

            <!-- History Tab -->
            <div id="content-history" style="display: none;">
                <div class="bg-white rounded-2xl shadow-lg p-5 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-lg font-semibold text-gray-800">üìú Riwayat Transaksi</h2>
                        <button onclick="app.clearHistory()" class="text-sm text-red-600 hover:text-red-700">
                            üóëÔ∏è Hapus Semua
                        </button>
                    </div>
                    <div id="historyList"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="content-settings" style="display: none;">
                <div class="space-y-4">
                    <!-- Time Rules Management -->
                    <div class="bg-white rounded-2xl shadow-lg p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">üìã Management Aturan Waktu</h2>
                            <button onclick="app.showAddRuleForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-semibold text-sm">
                                + Tambah Aturan
                            </button>
                        </div>
                        <div id="timeRulesList"></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-5">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3">üîê Keamanan</h2>
                        <button onclick="app.changePin()" 
                            class="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition font-semibold mb-2">
                            üîë Ubah PIN
                        </button>
                        <button onclick="app.lockApp()" 
                            class="w-full bg-yellow-500 text-white py-3 rounded-xl hover:bg-yellow-600 transition font-semibold">
                            üîí Kunci Aplikasi
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-5">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3">üìä Data</h2>
                        <button onclick="app.exportAllData()" 
                            class="w-full bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 transition font-semibold mb-2">
                            üì§ Export Semua Data
                        </button>
                        <button onclick="app.resetAllData()" 
                            class="w-full bg-red-500 text-white py-3 rounded-xl hover:bg-red-600 transition font-semibold">
                            üîÑ Reset Semua Data
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-5">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3">‚ÑπÔ∏è Info</h2>
                        <p class="text-sm text-gray-600 mb-2">üîÑ Status: <span id="connectionStatus" class="text-green-600 font-semibold">Terhubung</span></p>
                        <button onclick="app.resetFirebaseConfig()" 
                            class="w-full bg-gray-500 text-white py-3 rounded-xl hover:bg-gray-600 transition font-semibold">
                            üîÑ Ganti Firebase Config
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal untuk detail anak -->
        <div id="childDetailModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        const app = {
            db: null,
            auth: null,
            children: {},
            history: [],
            settings: {},
            tasks: {},
            schedules: {},
            timeRules: {},
            dailyTasks: [
                { id: 'bed', name: 'Tempat tidur: Rapi setiap pagi', category: 'daily' },
                { id: 'towel', name: 'Handuk: Dijemur setelah mandi', category: 'daily' },
                { id: 'bath', name: 'Mandi: Bersih (gigi, rambut, muka)', category: 'daily' },
                { id: 'uniform', name: 'Pakaian sekolah: Lengkap (termasuk peci, kaos kaki, ikat pinggang)', category: 'daily' },
                { id: 'terrace', name: 'Teras: Sapu jika kotor', category: 'daily' },
                { id: 'cloth', name: 'Kain: Lipat setiap selesai digunakan dan jemur jika ada cucian', category: 'daily' }
            ],
            saturdayTasks: [
                { id: 'iron', name: 'Menyetrika baju', category: 'saturday' },
                { id: 'sweep_inside', name: 'Menyapu dalam rumah', category: 'saturday' }
            ],
            sundayTasks: [
                { id: 'wash', name: 'Mencuci baju', category: 'sunday' },
                { id: 'dry_cloth', name: 'Menjemur kain', category: 'sunday' },
                { id: 'sweep_outside', name: 'Menyapu halaman luar sampai bersih', category: 'sunday' }
            ],
            bonusTasks: [
                { id: 'quran', name: 'Mengaji lebih dari 2 halaman', category: 'bonus', unit: 'per halaman', input: true },
                { id: 'schedule', name: 'Mengerjakan kegiatan sesuai jadwal tanpa terkecuali', category: 'bonus' },
                { id: 'help', name: 'Membantu dengan cepat dan ikhlas jika diminta tolong', category: 'bonus' }
            ],
            penaltyTasks: [
                { id: 'no_schedule', name: 'Tidak mengerjakan kegiatan sesuai jadwal', category: 'penalty' },
                { id: 'no_quran', name: 'Tidak mengaji Maghrib', category: 'penalty' },
                { id: 'no_english', name: 'Tidak ikut les English (Rabu/Kamis/Jumat/Sabtu)', category: 'penalty' },
                { id: 'fight', name: 'Berkelahi / berbicara dengan keras', category: 'penalty' }
            ],
            defaultTimeRules: {
                'daily_bed': { name: 'Tempat tidur rapi', points: 0, category: 'Tugas Harian' },
                'daily_towel': { name: 'Handuk dijemur', points: 0, category: 'Tugas Harian' },
                'daily_bath': { name: 'Mandi bersih', points: 0, category: 'Tugas Harian' },
                'daily_uniform': { name: 'Pakaian sekolah lengkap', points: 0, category: 'Tugas Harian' },
                'daily_terrace': { name: 'Teras disapu', points: 0, category: 'Tugas Harian' },
                'daily_cloth': { name: 'Kain dilipat', points: 0, category: 'Tugas Harian' },
                'saturday_iron': { name: 'Menyetrika baju', points: 0, category: 'Tugas Sabtu' },
                'saturday_sweep_inside': { name: 'Menyapu dalam rumah', points: 0, category: 'Tugas Sabtu' },
                'sunday_wash': { name: 'Mencuci baju', points: 0, category: 'Tugas Minggu' },
                'sunday_dry_cloth': { name: 'Menjemur kain', points: 0, category: 'Tugas Minggu' },
                'sunday_sweep_outside': { name: 'Menyapu halaman luar', points: 0, category: 'Tugas Minggu' },
                'bonus_quran': { name: 'Mengaji per halaman', points: 10, category: 'Bonus', unit: 'per halaman' },
                'bonus_schedule': { name: 'Sesuai jadwal tanpa terkecuali', points: 30, category: 'Bonus' },
                'bonus_help': { name: 'Membantu dengan ikhlas', points: 10, category: 'Bonus' },
                'penalty_no_schedule': { name: 'Tidak sesuai jadwal', points: -20, category: 'Penalty' },
                'penalty_no_quran': { name: 'Tidak mengaji Maghrib', points: -10, category: 'Penalty' },
                'penalty_no_english': { name: 'Tidak ikut les English', points: -20, category: 'Penalty' },
                'penalty_fight': { name: 'Berkelahi / keras', points: -20, category: 'Penalty' },
                'schedule_missed': { name: 'Tidak hadir jadwal (default)', points: -20, category: 'Jadwal' }
            },
            currentTab: 'dashboard',
            firebaseInitialized: false,
            isLocked: false,
            currentUser: null,

            init() {
                const config = localStorage.getItem('firebaseConfig');
                if (config) {
                    try {
                        const parsedConfig = JSON.parse(config);
                        this.initFirebase(parsedConfig);
                    } catch (e) {
                        console.error('Error loading config:', e);
                    }
                } else {
                    document.getElementById('setupSection').style.display = 'block';
                }
            },

            renderAnalytics() {
                const container = document.getElementById('analyticsContent');
                const childrenArray = Object.values(this.children);
                
                if (childrenArray.length === 0) {
                    container.innerHTML = '<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-400">Tambahkan anak terlebih dahulu untuk melihat statistik</div>';
                    return;
                }

                let html = '<div class="space-y-4">';

                // Time Period Selector
                html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                html += '<div class="flex items-center justify-between mb-4">';
                html += '<h2 class="text-xl font-bold text-gray-800">üìà Periode</h2>';
                html += '<select id="analytics-period" onchange="app.renderAnalytics()" class="px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold">';
                html += '<option value="7">7 Hari Terakhir</option>';
                html += '<option value="14">14 Hari Terakhir</option>';
                html += '<option value="30" selected>30 Hari Terakhir</option>';
                html += '</select>';
                html += '</div></div>';

                // Chart 1: Perkembangan Waktu per Anak
                html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                html += '<h3 class="text-lg font-bold text-gray-800 mb-4">üìä Perkembangan Waktu Belajar</h3>';
                html += '<canvas id="timeChart" style="max-height: 300px;"></canvas>';
                html += '</div>';

                // Chart 2: Pengeluaran Uang per Kategori
                html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                html += '<h3 class="text-lg font-bold text-gray-800 mb-4">üí∞ Pengeluaran per Kategori</h3>';
                html += '<canvas id="expenseChart" style="max-height: 300px;"></canvas>';
                html += '</div>';

                // Chart 3: Perbandingan Antar Anak
                html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                html += '<h3 class="text-lg font-bold text-gray-800 mb-4">üèÜ Perbandingan Antar Anak</h3>';
                html += '<canvas id="comparisonChart" style="max-height: 300px;"></canvas>';
                html += '</div>';

                html += '</div>';
                container.innerHTML = html;

                // Render charts after DOM is ready
                setTimeout(() => {
                    this.renderTimeChart();
                    this.renderExpenseChart();
                    this.renderComparisonChart();
                }, 100);
            },

            renderTimeChart() {
                const canvas = document.getElementById('timeChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const periodSelect = document.getElementById('analytics-period');
                const days = parseInt(periodSelect ? periodSelect.value : 30);

                const childrenArray = Object.values(this.children);
                const datasets = [];

                childrenArray.forEach(child => {
                    const data = [];
                    const now = new Date();
                    
                    for (let i = days - 1; i >= 0; i--) {
                        const date = new Date(now);
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toDateString();
                        
                        const dayHistory = this.history.filter(h => {
                            return h.childId === child.id && 
                                   h.type === 'time' && 
                                   new Date(h.timestamp).toDateString() === dateStr;
                        });
                        
                        const dayTotal = dayHistory.reduce((sum, h) => sum + (h.amount || 0), 0);
                        data.push(dayTotal);
                    }

                    datasets.push({
                        label: child.name,
                        data: data,
                        borderColor: child.color || '#667eea',
                        backgroundColor: (child.color || '#667eea') + '20',
                        tension: 0.4,
                        fill: true
                    });
                });

                const labels = [];
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }));
                }

                if (window.timeChartInstance) {
                    window.timeChartInstance.destroy();
                }

                window.timeChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Menit'
                                }
                            }
                        }
                    }
                });
            },

            renderExpenseChart() {
                const canvas = document.getElementById('expenseChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const childrenArray = Object.values(this.children);

                const categoryTotals = {};
                childrenArray.forEach(child => {
                    if (child.expenses) {
                        child.expenses.forEach(exp => {
                            const cat = exp.category || 'lainnya';
                            categoryTotals[cat] = (categoryTotals[cat] || 0) + exp.amount;
                        });
                    }
                });

                const labels = Object.keys(categoryTotals);
                const data = Object.values(categoryTotals);
                const colors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ];

                if (window.expenseChartInstance) {
                    window.expenseChartInstance.destroy();
                }

                if (labels.length === 0) {
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#999';
                    ctx.textAlign = 'center';
                    ctx.fillText('Belum ada data pengeluaran', canvas.width / 2, canvas.height / 2);
                    return;
                }

                window.expenseChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': Rp ' + context.parsed.toLocaleString('id-ID');
                                    }
                                }
                            }
                        }
                    }
                });
            },

            renderComparisonChart() {
                const canvas = document.getElementById('comparisonChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const childrenArray = Object.values(this.children);

                const labels = childrenArray.map(c => c.name);
                const timeData = childrenArray.map(c => c.minutes || 0);
                const moneyData = childrenArray.map(c => c.money || 0);
                const colors = childrenArray.map(c => c.color || '#667eea');

                if (window.comparisonChartInstance) {
                    window.comparisonChartInstance.destroy();
                }

                window.comparisonChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Waktu (menit)',
                                data: timeData,
                                backgroundColor: colors.map(c => c + 'CC'),
                                yAxisID: 'y'
                            },
                            {
                                label: 'Saldo (ribuan Rp)',
                                data: moneyData.map(m => m / 1000),
                                backgroundColor: colors.map(c => c + '66'),
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                type: 'linear',
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Waktu (menit)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Saldo (ribu Rp)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            },

            saveFirebaseConfig() {
                const config = {
                    apiKey: document.getElementById('apiKey').value.trim(),
                    authDomain: document.getElementById('authDomain').value.trim(),
                    databaseURL: document.getElementById('databaseURL').value.trim(),
                    projectId: document.getElementById('projectId').value.trim()
                };

                if (!config.apiKey || !config.databaseURL) {
                    alert('API Key dan Database URL harus diisi!');
                    return;
                }

                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                this.initFirebase(config);
            },

            initFirebase(config) {
                try {
                    if (!this.firebaseInitialized) {
                        firebase.initializeApp(config);
                        this.firebaseInitialized = true;
                    }
                    
                    this.db = firebase.database();
                    this.auth = firebase.auth();
                    
                    document.getElementById('setupSection').style.display = 'none';
                    document.getElementById('authLoadingSection').style.display = 'block';
                    
                    // Anonymous Auth
                    this.auth.onAuthStateChanged((user) => {
                        if (user) {
                            this.currentUser = user;
                            console.log('User authenticated:', user.uid);
                            document.getElementById('authLoadingSection').style.display = 'none';
                            
                            // Check if PIN exists
                            this.db.ref('settings/pin').once('value', (snapshot) => {
                                if (snapshot.exists()) {
                                    this.settings.pin = snapshot.val();
                                    this.showPinLock();
                                } else {
                                    document.getElementById('pinSetupSection').style.display = 'block';
                                }
                            });
                            
                            this.listenToChanges();
                        } else {
                            // Sign in anonymously
                            this.auth.signInAnonymously().catch((error) => {
                                console.error('Auth error:', error);
                                alert('Error authentication: ' + error.message);
                                document.getElementById('authLoadingSection').style.display = 'none';
                            });
                        }
                    });
                    
                    this.db.ref('.info/connected').on('value', (snapshot) => {
                        const status = document.getElementById('connectionStatus');
                        if (status) {
                            if (snapshot.val() === true) {
                                status.textContent = 'Terhubung';
                                status.className = 'text-green-600 font-semibold';
                            } else {
                                status.textContent = 'Terputus';
                                status.className = 'text-red-600 font-semibold';
                            }
                        }
                    });
                } catch (e) {
                    alert('Error inisialisasi Firebase: ' + e.message);
                }
            },

            setupPin() {
                const pin = document.getElementById('newPin').value;
                const confirm = document.getElementById('confirmPin').value;

                if (pin.length < 4) {
                    alert('PIN minimal 4 digit!');
                    return;
                }

                if (pin !== confirm) {
                    alert('PIN tidak cocok!');
                    return;
                }

                this.db.ref('settings/pin').set(pin);
                this.settings.pin = pin;
                document.getElementById('pinSetupSection').style.display = 'none';
                this.showApp();
            },

            skipPin() {
                if (confirm('Yakin tidak pakai PIN? Anak bisa ubah data sendiri.')) {
                    document.getElementById('pinSetupSection').style.display = 'none';
                    this.showApp();
                }
            },

            showPinLock() {
                this.isLocked = true;
                document.getElementById('pinLockSection').style.display = 'block';
                document.getElementById('appSection').style.display = 'none';
            },

            verifyPin() {
                const entered = document.getElementById('enterPin').value;
                if (entered === this.settings.pin) {
                    this.isLocked = false;
                    document.getElementById('pinLockSection').style.display = 'none';
                    this.showApp();
                } else {
                    alert('PIN salah!');
                    document.getElementById('enterPin').value = '';
                }
            },

            lockApp() {
                if (this.settings.pin) {
                    this.showPinLock();
                } else {
                    alert('PIN belum diatur!');
                }
            },

            changePin() {
                if (this.settings.pin) {
                    const oldPin = prompt('Masukkan PIN lama:');
                    if (oldPin !== this.settings.pin) {
                        alert('PIN lama salah!');
                        return;
                    }
                }
                
                const newPin = prompt('Masukkan PIN baru (4-6 digit):');
                if (newPin && newPin.length >= 4) {
                    const confirm = prompt('Konfirmasi PIN baru:');
                    if (newPin === confirm) {
                        this.db.ref('settings/pin').set(newPin);
                        this.settings.pin = newPin;
                        alert('PIN berhasil diubah!');
                    } else {
                        alert('PIN tidak cocok!');
                    }
                }
            },

            showApp() {
                document.getElementById('appSection').style.display = 'block';
                this.switchTab('dashboard');
            },

            listenToChanges() {
                this.db.ref('children').on('value', (snapshot) => {
                    this.children = snapshot.val() || {};
                    this.renderCurrentTab();
                });

                this.db.ref('history').limitToLast(100).on('value', (snapshot) => {
                    const data = snapshot.val();
                    this.history = data ? Object.values(data).reverse() : [];
                    if (this.currentTab === 'history') {
                        this.renderHistory();
                    }
                });

                this.db.ref('settings').on('value', (snapshot) => {
                    this.settings = snapshot.val() || {};
                });

                this.db.ref('tasks').on('value', (snapshot) => {
                    this.tasks = snapshot.val() || {};
                    if (this.currentTab === 'tasks') {
                        this.renderTasks();
                    }
                    this.checkAndResetTasks();
                });

                this.db.ref('schedules').on('value', (snapshot) => {
                    this.schedules = snapshot.val() || {};
                    if (this.currentTab === 'schedule') {
                        this.renderSchedule();
                    }
                    this.checkAndResetSchedules();
                });

                this.db.ref('timeRules').on('value', (snapshot) => {
                    this.timeRules = snapshot.val() || {};
                    if (Object.keys(this.timeRules).length === 0) {
                        this.db.ref('timeRules').set(this.defaultTimeRules);
                    }
                });
            },

            renderTimeRules() {
                const container = document.getElementById('timeRulesList');
                if (!container) return;

                const rules = this.timeRules || this.defaultTimeRules;
                const categories = {};

                Object.entries(rules).forEach(([key, rule]) => {
                    const cat = rule.category || 'Lainnya';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push({ key, ...rule });
                });

                let html = '';
                Object.entries(categories).forEach(([category, rulesList]) => {
                    html += '<div class="mb-4">';
                    html += '<h3 class="font-bold text-gray-700 mb-2">' + category + '</h3>';
                    html += '<div class="space-y-2">';
                    
                    rulesList.forEach(rule => {
                        const color = rule.points > 0 ? 'text-green-600' : rule.points < 0 ? 'text-red-600' : 'text-gray-600';
                        const sign = rule.points > 0 ? '+' : '';
                        
                        html += '<div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">';
                        html += '<div class="flex-1">';
                        html += '<div class="font-semibold text-sm">' + rule.name + '</div>';
                        html += '<div class="text-xs ' + color + ' font-bold">' + sign + rule.points + ' menit' + (rule.unit ? ' ' + rule.unit : '') + '</div>';
                        html += '</div>';
                        html += '<div class="flex gap-2">';
                        html += '<button onclick="app.editRule(\'' + rule.key + '\')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">Edit</button>';
                        html += '<button onclick="app.deleteRule(\'' + rule.key + '\')" class="text-red-600 hover:text-red-800 text-sm font-semibold">Hapus</button>';
                        html += '</div>';
                        html += '</div>';
                    });
                    
                    html += '</div></div>';
                });

                container.innerHTML = html;
            },

            showAddRuleForm() {
                const html = '<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px;">' +
                    '<div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 100%;">' +
                    '<h3 class="text-xl font-bold mb-4">Tambah Aturan Baru</h3>' +
                    '<div class="space-y-3">' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Nama Aturan</label>' +
                    '<input type="text" id="rule-name" placeholder="Contoh: Mencuci piring" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg"></div>' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Kategori</label>' +
                    '<select id="rule-category" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg">' +
                    '<option value="Tugas Harian">Tugas Harian</option>' +
                    '<option value="Tugas Sabtu">Tugas Sabtu</option>' +
                    '<option value="Tugas Minggu">Tugas Minggu</option>' +
                    '<option value="Bonus">Bonus</option>' +
                    '<option value="Penalty">Penalty</option>' +
                    '<option value="Jadwal">Jadwal</option>' +
                    '<option value="Lainnya">Lainnya</option>' +
                    '</select></div>' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Waktu (menit)</label>' +
                    '<input type="number" id="rule-points" placeholder="Contoh: 10 atau -20" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg"></div>' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Unit (opsional)</label>' +
                    '<input type="text" id="rule-unit" placeholder="Contoh: per halaman" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg"></div>' +
                    '<div class="flex gap-2">' +
                    '<button onclick="app.saveNewRule()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-semibold">Simpan</button>' +
                    '<button onclick="app.closeRuleForm()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 font-semibold">Batal</button>' +
                    '</div></div></div></div>';

                document.body.insertAdjacentHTML('beforeend', html);
            },

            editRule(ruleKey) {
                const rule = this.timeRules[ruleKey];
                if (!rule) return;

                const html = '<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px;">' +
                    '<div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 100%;">' +
                    '<h3 class="text-xl font-bold mb-4">Edit Aturan</h3>' +
                    '<div class="space-y-3">' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Nama Aturan</label>' +
                    '<input type="text" id="edit-rule-name" value="' + rule.name + '" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg"></div>' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Kategori</label>' +
                    '<select id="edit-rule-category" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg">' +
                    '<option value="Tugas Harian" ' + (rule.category === 'Tugas Harian' ? 'selected' : '') + '>Tugas Harian</option>' +
                    '<option value="Tugas Sabtu" ' + (rule.category === 'Tugas Sabtu' ? 'selected' : '') + '>Tugas Sabtu</option>' +
                    '<option value="Tugas Minggu" ' + (rule.category === 'Tugas Minggu' ? 'selected' : '') + '>Tugas Minggu</option>' +
                    '<option value="Bonus" ' + (rule.category === 'Bonus' ? 'selected' : '') + '>Bonus</option>' +
                    '<option value="Penalty" ' + (rule.category === 'Penalty' ? 'selected' : '') + '>Penalty</option>' +
                    '<option value="Jadwal" ' + (rule.category === 'Jadwal' ? 'selected' : '') + '>Jadwal</option>' +
                    '<option value="Lainnya" ' + (rule.category === 'Lainnya' ? 'selected' : '') + '>Lainnya</option>' +
                    '</select></div>' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Waktu (menit)</label>' +
                    '<input type="number" id="edit-rule-points" value="' + rule.points + '" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg"></div>' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Unit (opsional)</label>' +
                    '<input type="text" id="edit-rule-unit" value="' + (rule.unit || '') + '" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg"></div>' +
                    '<div class="flex gap-2">' +
                    '<button onclick="app.saveEditedRule(\'' + ruleKey + '\')" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-semibold">Simpan</button>' +
                    '<button onclick="app.closeRuleForm()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 font-semibold">Batal</button>' +
                    '</div></div></div></div>';

                document.body.insertAdjacentHTML('beforeend', html);
            },

            closeRuleForm() {
                const modal = document.querySelector('[style*="position: fixed"]');
                if (modal) modal.remove();
            },

            saveNewRule() {
                const name = document.getElementById('rule-name').value.trim();
                const category = document.getElementById('rule-category').value;
                const points = parseInt(document.getElementById('rule-points').value);
                const unit = document.getElementById('rule-unit').value.trim();

                if (!name || isNaN(points)) {
                    alert('Nama dan waktu harus diisi!');
                    return;
                }

                const ruleKey = 'custom_' + Date.now();
                const rule = {
                    name: name,
                    category: category,
                    points: points,
                    unit: unit || null
                };

                this.db.ref('timeRules/' + ruleKey).set(rule);
                this.addHistory('Aturan baru ditambahkan: ' + name, 'settings', null);

                this.closeRuleForm();
                alert('‚úì Aturan berhasil ditambahkan!');
            },

            saveEditedRule(ruleKey) {
                const name = document.getElementById('edit-rule-name').value.trim();
                const category = document.getElementById('edit-rule-category').value;
                const points = parseInt(document.getElementById('edit-rule-points').value);
                const unit = document.getElementById('edit-rule-unit').value.trim();

                if (!name || isNaN(points)) {
                    alert('Nama dan waktu harus diisi!');
                    return;
                }

                const rule = {
                    name: name,
                    category: category,
                    points: points,
                    unit: unit || null
                };

                this.db.ref('timeRules/' + ruleKey).set(rule);
                this.addHistory('Aturan diubah: ' + name, 'settings', null);

                this.closeRuleForm();
                alert('‚úì Aturan berhasil diupdate!');
            },

            deleteRule(ruleKey) {
                const rule = this.timeRules[ruleKey];
                if (confirm('Hapus aturan "' + rule.name + '"?')) {
                    this.db.ref('timeRules/' + ruleKey).remove();
                    this.addHistory('Aturan dihapus: ' + rule.name, 'settings', null);
                    alert('‚úì Aturan berhasil dihapus!');
                }
            },

            checkAndResetSchedules() {
                const today = new Date().toDateString();
                const lastReset = this.schedules.lastReset;
                
                if (lastReset !== today) {
                    const completed = this.schedules.completed || {};
                    this.db.ref('schedules').set({
                        lastReset: today,
                        completed: {},
                        items: this.schedules.items || {}
                    });
                }
            },

            checkAndResetTasks() {
                const today = new Date().toDateString();
                const lastReset = this.tasks.lastReset;
                
                if (lastReset !== today) {
                    this.db.ref('tasks').set({
                        lastReset: today,
                        completed: {}
                    });
                }
            },

            renderTasks() {
                const container = document.getElementById('tasksContent');
                const childrenArray = Object.values(this.children);
                
                if (childrenArray.length === 0) {
                    container.innerHTML = '<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-400">Tambahkan anak terlebih dahulu di tab Kelola</div>';
                    return;
                }

                const dayOfWeek = new Date().getDay();
                const isSaturday = dayOfWeek === 6;
                const isSunday = dayOfWeek === 0;

                let html = '<div class="space-y-4">';

                // Tugas Harian
                html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                html += '<h2 class="text-xl font-bold text-gray-800 mb-4">üìã Tugas Harian</h2>';
                html += '<div class="space-y-2">';
                this.dailyTasks.forEach(task => {
                    html += this.renderTaskItem(task, 'daily', childrenArray);
                });
                html += '</div></div>';

                // Tugas Sabtu
                if (isSaturday) {
                    html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                    html += '<h2 class="text-xl font-bold text-blue-600 mb-4">üßπ Tugas Sabtu</h2>';
                    html += '<div class="space-y-2">';
                    this.saturdayTasks.forEach(task => {
                        html += this.renderTaskItem(task, 'saturday', childrenArray);
                    });
                    html += '</div></div>';
                }

                // Tugas Minggu
                if (isSunday) {
                    html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                    html += '<h2 class="text-xl font-bold text-purple-600 mb-4">üßΩ Tugas Minggu</h2>';
                    html += '<div class="space-y-2">';
                    this.sundayTasks.forEach(task => {
                        html += this.renderTaskItem(task, 'sunday', childrenArray);
                    });
                    html += '</div></div>';
                }

                // Bonus
                html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                html += '<h2 class="text-xl font-bold text-green-600 mb-4">üåü Bonus Waktu</h2>';
                html += '<div class="space-y-2">';
                this.bonusTasks.forEach(task => {
                    html += this.renderTaskItem(task, 'bonus', childrenArray);
                });
                html += '</div></div>';

                // Pengurangan
                html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                html += '<h2 class="text-xl font-bold text-red-600 mb-4">‚ö†Ô∏è Pengurangan Waktu</h2>';
                html += '<div class="space-y-2">';
                this.penaltyTasks.forEach(task => {
                    html += this.renderTaskItem(task, 'penalty', childrenArray);
                });
                html += '</div></div>';

                html += '</div>';
                container.innerHTML = html;
            },

            renderTaskItem(task, category, childrenArray) {
                const ruleKey = category + '_' + task.id;
                const rule = this.timeRules[ruleKey] || { points: 0 };
                const points = rule.points || 0;

                let html = '<div class="border-2 border-gray-200 rounded-xl p-4">';
                html += '<div class="mb-3">';
                html += '<div class="font-semibold text-gray-800">' + task.name + '</div>';
                if (points !== 0) {
                    const color = points > 0 ? 'text-green-600' : 'text-red-600';
                    const sign = points > 0 ? '+' : '';
                    html += '<div class="text-sm ' + color + ' font-bold">' + sign + points + ' menit' + (rule.unit ? ' ' + rule.unit : '') + '</div>';
                }
                html += '</div>';

                if (task.input) {
                    html += '<div class="mb-3">';
                    html += '<input type="number" id="input-' + category + '-' + task.id + '" placeholder="Jumlah halaman lebih dari 2..." min="1" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm">';
                    html += '</div>';
                }

                html += '<div class="space-y-2">';
                childrenArray.forEach(child => {
                    const taskKey = category + '_' + task.id + '_' + child.id;
                    const completed = this.tasks.completed && this.tasks.completed[taskKey];
                    
                    html += '<div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg">';
                    html += '<span class="text-sm font-medium" style="color: ' + (child.color || '#667eea') + '">' + child.name + '</span>';
                    html += '<button onclick="app.toggleTask(\'' + taskKey + '\', ' + child.id + ', ' + points + ', \'' + task.name + '\', \'' + category + '\', \'' + task.id + '\')" class="' + (completed ? 'bg-green-500' : 'bg-gray-300') + ' text-white px-4 py-1 rounded-lg font-semibold text-sm">';
                    html += completed ? '‚úì Selesai' : 'Tandai';
                    html += '</button>';
                    html += '</div>';
                });
                html += '</div>';

                html += '</div>';
                return html;
            },

            toggleTask(taskKey, childId, points, taskName, category, taskId) {
                if (!this.settings.pin) {
                    this.executeToggleTask(taskKey, childId, points, taskName, category, taskId);
                    return;
                }

                const pin = prompt('üîê Masukkan PIN Orang Tua:');
                if (pin === this.settings.pin) {
                    this.executeToggleTask(taskKey, childId, points, taskName, category, taskId);
                } else if (pin !== null) {
                    alert('‚ùå PIN salah!');
                }
            },

            executeToggleTask(taskKey, childId, points, taskName, category, taskId) {
                const completed = this.tasks.completed || {};
                const isCompleted = completed[taskKey];

                const ruleKey = category + '_' + taskId;
                const rule = this.timeRules[ruleKey] || { points: points };
                let finalPoints = rule.points || points;

                if (isCompleted) {
                    delete completed[taskKey];
                    this.db.ref('tasks/completed/' + taskKey).remove();
                    
                    const child = this.children[childId];
                    this.addHistory(child.name + ': Batal - ' + taskName, 'task', childId);
                    alert('‚úì Task dibatalkan untuk ' + child.name);
                } else {
                    if (category === 'bonus' && taskId === 'quran') {
                        const input = document.getElementById('input-' + category + '-' + taskId);
                        const pages = parseInt(input.value);
                        if (!pages || pages < 1) {
                            alert('Masukkan jumlah halaman yang valid!');
                            return;
                        }
                        finalPoints = rule.points * pages;
                    }

                    completed[taskKey] = true;
                    this.db.ref('tasks/completed/' + taskKey).set(true);
                    
                    this.updateTime(childId, finalPoints, taskName);
                    
                    const child = this.children[childId];
                    alert('‚úì Task selesai untuk ' + child.name + ' (' + (finalPoints > 0 ? '+' : '') + finalPoints + ' menit)');
                }
            },

            renderSchedule() {
                const container = document.getElementById('scheduleContent');
                const childrenArray = Object.values(this.children);
                
                if (childrenArray.length === 0) {
                    container.innerHTML = '<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-400">Tambahkan anak terlebih dahulu di tab Kelola</div>';
                    return;
                }

                const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                const today = new Date().getDay();

                let html = '<div class="space-y-4">';

                childrenArray.forEach(child => {
                    html += '<div class="bg-white rounded-2xl shadow-lg p-5">';
                    html += '<div class="flex items-center justify-between mb-4">';
                    html += '<h2 class="text-xl font-bold" style="color: ' + (child.color || '#667eea') + '">üìö ' + child.name + '</h2>';
                    html += '<button onclick="app.showAddScheduleForm(' + child.id + ')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-semibold text-sm">+ Tambah Jadwal</button>';
                    html += '</div>';

                    const childSchedules = this.schedules.items && this.schedules.items[child.id] ? this.schedules.items[child.id] : {};

                    for (let day = 0; day < 7; day++) {
                        const daySchedules = Object.values(childSchedules).filter(s => s.day === day);
                        if (daySchedules.length > 0) {
                            const isToday = day === today;
                            html += '<div class="mb-3 ' + (isToday ? 'border-2 border-indigo-500' : 'border-2 border-gray-200') + ' rounded-xl p-3">';
                            html += '<div class="font-bold text-gray-800 mb-2">' + (isToday ? 'üìç ' : '') + days[day] + (isToday ? ' (Hari Ini)' : '') + '</div>';
                            html += '<div class="space-y-2">';

                            daySchedules.sort((a, b) => a.time.localeCompare(b.time)).forEach(schedule => {
                                const scheduleKey = child.id + '_' + schedule.id;
                                const completed = this.schedules.completed && this.schedules.completed[scheduleKey];
                                
                                html += '<div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg">';
                                html += '<div class="flex-1">';
                                html += '<div class="font-semibold text-sm">' + schedule.time + ' - ' + schedule.name + '</div>';
                                if (schedule.penalty) {
                                    html += '<div class="text-xs text-red-600">Tidak hadir: -' + schedule.penalty + ' menit</div>';
                                }
                                html += '</div>';
                                html += '<div class="flex gap-2">';
                                if (isToday) {
                                    html += '<button onclick="app.toggleSchedule(\'' + scheduleKey + '\', ' + child.id + ', ' + (schedule.penalty || 0) + ', \'' + schedule.name + '\')" class="' + (completed ? 'bg-green-500' : 'bg-gray-300') + ' text-white px-3 py-1 rounded-lg font-semibold text-sm">';
                                    html += completed ? '‚úì' : '‚óã';
                                    html += '</button>';
                                }
                                html += '<button onclick="app.deleteSchedule(' + child.id + ', \'' + schedule.id + '\')" class="text-red-500 hover:text-red-700 px-2">üóëÔ∏è</button>';
                                html += '</div>';
                                html += '</div>';
                            });

                            html += '</div></div>';
                        }
                    }

                    if (Object.keys(childSchedules).length === 0) {
                        html += '<p class="text-gray-400 text-center py-4">Belum ada jadwal. Klik "Tambah Jadwal" untuk membuat jadwal baru.</p>';
                    }

                    html += '</div>';
                });

                html += '</div>';
                container.innerHTML = html;
            },

            showAddScheduleForm(childId) {
                const child = this.children[childId];
                const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

                let dayOptions = '';
                days.forEach((day, index) => {
                    dayOptions += '<option value="' + index + '">' + day + '</option>';
                });

                const html = '<div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px;">' +
                    '<div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 100%;">' +
                    '<h3 class="text-xl font-bold mb-4">Tambah Jadwal untuk ' + child.name + '</h3>' +
                    '<div class="space-y-3">' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Hari</label>' +
                    '<select id="schedule-day" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg">' + dayOptions + '</select></div>' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Waktu (HH:MM)</label>' +
                    '<input type="time" id="schedule-time" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg"></div>' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Nama Kegiatan</label>' +
                    '<input type="text" id="schedule-name" placeholder="Contoh: Les English" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg"></div>' +
                    '<div><label class="text-sm font-semibold text-gray-700 block mb-1">Pengurangan Waktu jika Tidak Hadir (menit)</label>' +
                    '<input type="number" id="schedule-penalty" value="' + (this.timeRules.schedule_missed?.points ? Math.abs(this.timeRules.schedule_missed.points) : 20) + '" min="0" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg"></div>' +
                    '<div class="flex gap-2">' +
                    '<button onclick="app.saveSchedule(' + childId + ')" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-semibold">Simpan</button>' +
                    '<button onclick="app.closeScheduleForm()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 font-semibold">Batal</button>' +
                    '</div></div></div></div>';

                document.body.insertAdjacentHTML('beforeend', html);
            },

            closeScheduleForm() {
                const modal = document.querySelector('[style*="position: fixed"]');
                if (modal) modal.remove();
            },

            saveSchedule(childId) {
                const day = parseInt(document.getElementById('schedule-day').value);
                const time = document.getElementById('schedule-time').value;
                const name = document.getElementById('schedule-name').value.trim();
                const penalty = parseInt(document.getElementById('schedule-penalty').value) || 0;

                if (!time || !name) {
                    alert('Waktu dan nama kegiatan harus diisi!');
                    return;
                }

                const scheduleId = Date.now();
                const schedule = {
                    id: scheduleId,
                    day: day,
                    time: time,
                    name: name,
                    penalty: penalty
                };

                this.db.ref('schedules/items/' + childId + '/' + scheduleId).set(schedule);
                
                const child = this.children[childId];
                this.addHistory(child.name + ': Jadwal ditambahkan - ' + name, 'schedule', childId);

                this.closeScheduleForm();
                alert('‚úì Jadwal berhasil ditambahkan!');
            },

            deleteSchedule(childId, scheduleId) {
                if (confirm('Hapus jadwal ini?')) {
                    this.db.ref('schedules/items/' + childId + '/' + scheduleId).remove();
                    
                    const child = this.children[childId];
                    this.addHistory(child.name + ': Jadwal dihapus', 'schedule', childId);
                }
            },

            toggleSchedule(scheduleKey, childId, penalty, scheduleName) {
                const completed = this.schedules.completed || {};
                const isCompleted = completed[scheduleKey];

                if (isCompleted) {
                    this.db.ref('schedules/completed/' + scheduleKey).remove();
                    
                    const child = this.children[childId];
                    this.addHistory(child.name + ': Batal hadir - ' + scheduleName, 'schedule', childId);
                } else {
                    this.db.ref('schedules/completed/' + scheduleKey).set(true);
                    
                    const child = this.children[childId];
                    this.addHistory(child.name + ': Hadir - ' + scheduleName, 'schedule', childId);
                }
            },

            checkMissedSchedules() {
                if (!this.schedules.items) return;

                const now = new Date();
                const today = now.getDay();
                const currentTime = now.getHours() * 60 + now.getMinutes();

                Object.entries(this.schedules.items).forEach(([childId, schedules]) => {
                    Object.values(schedules).forEach(schedule => {
                        if (schedule.day === today && schedule.penalty > 0) {
                            const scheduleTime = parseInt(schedule.time.split(':')[0]) * 60 + parseInt(schedule.time.split(':')[1]);
                            
                            if (currentTime > scheduleTime + 60) {
                                const scheduleKey = childId + '_' + schedule.id;
                                const completed = this.schedules.completed && this.schedules.completed[scheduleKey];
                                
                                if (!completed) {
                                    const alreadyPenalized = this.schedules.penalized && this.schedules.penalized[scheduleKey];
                                    if (!alreadyPenalized) {
                                        this.updateTime(childId, -schedule.penalty, 'Tidak hadir: ' + schedule.name);
                                        this.db.ref('schedules/penalized/' + scheduleKey).set(true);
                                    }
                                }
                            }
                        }
                    });
                });
            },

            switchTab(tab) {
                this.currentTab = tab;
                
                ['dashboard', 'analytics', 'schedule', 'tasks', 'manage', 'history', 'settings'].forEach(t => {
                    document.getElementById('content-' + t).style.display = 'none';
                    const btn = document.getElementById('tab-' + t);
                    if (btn) {
                        btn.className = 'flex-1 py-3 rounded-xl font-semibold transition text-gray-600 hover:bg-gray-100 whitespace-nowrap';
                    }
                });
                
                document.getElementById('content-' + tab).style.display = 'block';
                const activeBtn = document.getElementById('tab-' + tab);
                if (activeBtn) {
                    activeBtn.className = 'flex-1 py-3 rounded-xl font-semibold transition bg-indigo-600 text-white whitespace-nowrap';
                }
                
                this.renderCurrentTab();
            },

            renderCurrentTab() {
                switch(this.currentTab) {
                    case 'dashboard':
                        this.renderDashboard();
                        break;
                    case 'analytics':
                        this.renderAnalytics();
                        break;
                    case 'schedule':
                        this.renderSchedule();
                        break;
                    case 'tasks':
                        this.renderTasks();
                        break;
                    case 'manage':
                        this.renderManage();
                        break;
                    case 'history':
                        this.renderHistory();
                        break;
                    case 'settings':
                        this.renderTimeRules();
                        break;
                }
            },

            addChild() {
                const name = document.getElementById('newChildName').value.trim();
                const color = document.getElementById('newChildColor').value;
                const target = parseInt(document.getElementById('newChildTarget').value) || 60;
                const reward = parseInt(document.getElementById('newChildReward').value) || 5000;

                if (!name) {
                    alert('Nama anak harus diisi!');
                    return;
                }

                const newChild = {
                    id: Date.now(),
                    name: name,
                    color: color,
                    minutes: 0,
                    money: 0,
                    dailyTarget: target,
                    rewardAmount: reward,
                    badges: [],
                    expenses: [],
                    createdAt: Date.now()
                };

                this.db.ref('children/' + newChild.id).set(newChild);
                this.addHistory('Anak baru ditambahkan: ' + name, 'add_child', newChild.id);
                
                document.getElementById('newChildName').value = '';
                document.getElementById('newChildColor').value = '#667eea';
                document.getElementById('newChildTarget').value = '60';
                document.getElementById('newChildReward').value = '5000';

                alert('Anak berhasil ditambahkan!');
            },

            removeChild(id) {
                const child = this.children[id];
                if (confirm('Yakin ingin menghapus ' + child.name + '?')) {
                    this.db.ref('children/' + id).remove();
                    this.addHistory('Anak dihapus: ' + child.name, 'remove_child', id);
                }
            },

            updateTime(id, amount, description) {
                const child = this.children[id];
                if (child) {
                    const newMinutes = Math.max(0, child.minutes + amount);
                    this.db.ref('children/' + id + '/minutes').set(newMinutes);
                    
                    const desc = description || (amount > 0 ? 'Tambah ' + amount + ' menit' : 'Kurangi ' + Math.abs(amount) + ' menit');
                    this.addHistory(child.name + ': ' + desc, 'time', id, amount);
                    
                    // Check achievement
                    this.checkDailyTarget(id);
                }
            },

            updateMoney(id, amount, category, description) {
                const child = this.children[id];
                if (child) {
                    const currentMoney = child.money || 0;
                    const newMoney = Math.max(0, currentMoney + amount);
                    this.db.ref('children/' + id + '/money').set(newMoney);
                    
                    const desc = description || (amount > 0 ? 'Tambah Rp ' + amount.toLocaleString('id-ID') : 'Kurangi Rp ' + Math.abs(amount).toLocaleString('id-ID'));
                    this.addHistory(child.name + ': ' + desc, 'money', id, amount);
                    
                    if (amount < 0 && category) {
                        this.addExpense(id, Math.abs(amount), category, description);
                    }
                }
            },

            updateMoneyManual(id, isAdd) {
                const input = document.getElementById('manual-money-' + id);
                const value = parseInt(input.value);
                if (!isNaN(value) && value > 0) {
                    this.updateMoney(id, isAdd ? value : -value, null, null);
                    input.value = '';
                } else if (input.value.trim() !== '') {
                    alert('Masukkan angka yang valid!');
                }
            },

            addExpense(childId, amount, category, note) {
                const child = this.children[childId];
                if (child) {
                    const expenses = child.expenses || [];
                    expenses.push({
                        amount: amount,
                        category: category,
                        note: note || '',
                        date: Date.now()
                    });
                    this.db.ref('children/' + childId + '/expenses').set(expenses);
                }
            },

            checkDailyTarget(id) {
                const child = this.children[id];
                const target = child.dailyTarget || 60;
                
                if (child.minutes >= target && child.minutes - target < 30) {
                    const reward = child.rewardAmount || 5000;
                    this.updateMoney(id, reward, 'reward', 'Bonus target harian!');
                    this.addBadge(id, 'üéØ Target Harian');
                    alert('üéâ ' + child.name + ' mencapai target! Bonus Rp ' + reward.toLocaleString('id-ID'));
                }
            },

            addBadge(childId, badgeName) {
                const child = this.children[childId];
                if (child) {
                    const badges = child.badges || [];
                    if (!badges.includes(badgeName)) {
                        badges.push(badgeName);
                        this.db.ref('children/' + childId + '/badges').set(badges);
                    }
                }
            },

            addHistory(description, type, childId, amount) {
                const historyItem = {
                    id: Date.now(),
                    description: description,
                    type: type,
                    childId: childId || null,
                    amount: amount || 0,
                    timestamp: Date.now()
                };
                this.db.ref('history/' + historyItem.id).set(historyItem);
            },

            clearHistory() {
                if (confirm('Hapus semua riwayat?')) {
                    this.db.ref('history').remove();
                    alert('Riwayat dihapus!');
                }
            },

            undoLastAction() {
                if (this.history.length === 0) {
                    alert('Tidak ada transaksi untuk di-undo');
                    return;
                }

                const last = this.history[0];
                if (confirm('Undo: ' + last.description + '?')) {
                    const child = this.children[last.childId];
                    if (child && last.type === 'time') {
                        this.updateTime(last.childId, -last.amount, 'Undo: ' + last.description);
                    } else if (child && last.type === 'money') {
                        this.updateMoney(last.childId, -last.amount, null, 'Undo: ' + last.description);
                    }
                }
            },

            showChildDetail(id) {
                const child = this.children[id];
                if (!child) return;

                const modal = document.getElementById('childDetailModal');
                const content = document.getElementById('modalContent');
                
                const expenses = child.expenses || [];
                const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0);

                content.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold" style="color: ${child.color}">${child.name}</h2>
                            <button onclick="app.closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="p-4 rounded-xl text-center" style="background: ${child.color}20; color: ${child.color}">
                                <div class="text-sm opacity-80">Waktu Total</div>
                                <div class="text-2xl font-bold">${this.formatTime(child.minutes)}</div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-xl text-center text-green-700">
                                <div class="text-sm opacity-80">Saldo</div>
                                <div class="text-2xl font-bold">${this.formatMoney(child.money || 0)}</div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="font-semibold mb-2">üéØ Target Harian: ${child.dailyTarget || 60} menit</h3>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="bg-green-500 h-4 rounded-full" style="width: ${Math.min(100, (child.minutes / (child.dailyTarget || 60)) * 100)}%"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${Math.floor((child.minutes / (child.dailyTarget || 60)) * 100)}% tercapai</p>
                        </div>

                        <div class="mb-6">
                            <h3 class="font-semibold mb-2">üèÜ Badges</h3>
                            <div class="flex flex-wrap gap-2">
                                ${(child.badges || []).map(badge => `<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">${badge}</span>`).join('') || '<span class="text-gray-400 text-sm">Belum ada badge</span>'}
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="font-semibold mb-2">üí≥ Pengeluaran (Total: ${this.formatMoney(totalSpent)})</h3>
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${expenses.slice(-10).reverse().map(exp => `
                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg text-sm">
                                        <div>
                                            <div class="font-semibold">${exp.category}</div>
                                            <div class="text-gray-600 text-xs">${exp.note}</div>
                                        </div>
                                        <div class="text-red-600 font-bold">-${this.formatMoney(exp.amount)}</div>
                                    </div>
                                `).join('') || '<p class="text-gray-400 text-sm">Belum ada pengeluaran</p>'}
                            </div>
                        </div>

                                                    <div class="space-y-3">
                            <h3 class="font-semibold">‚öôÔ∏è Kelola ${child.name}</h3>
                            
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1">Target Harian (menit)</label>
                                    <input type="number" id="edit-target-${id}" value="${child.dailyTarget || 60}" 
                                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm" min="0">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1">Reward (Rp)</label>
                                    <input type="number" id="edit-reward-${id}" value="${child.rewardAmount || 5000}" 
                                        class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm" min="0" step="1000">
                                </div>
                            </div>
                            <button onclick="app.updateChildSettings(${id})" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 text-sm font-semibold mb-3">
                                üíæ Simpan Pengaturan
                            </button>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="app.showAddTimeForm(${id})" class="bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
                                    ‚ûï Tambah Waktu
                                </button>
                                <button onclick="app.showAddMoneyForm(${id})" class="bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                                    üí∞ Tambah Uang
                                </button>
                                <button onclick="app.showSpendMoneyForm(${id})" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                                    üí∏ Belanja
                                </button>
                                <button onclick="app.resetDailyTime(${id})" class="bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600">
                                    üîÑ Reset Waktu
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
            },

            updateChildSettings(id) {
                const newTarget = parseInt(document.getElementById('edit-target-' + id).value);
                const newReward = parseInt(document.getElementById('edit-reward-' + id).value);
                
                if (isNaN(newTarget) || newTarget < 0) {
                    alert('Target harus angka positif!');
                    return;
                }
                
                if (isNaN(newReward) || newReward < 0) {
                    alert('Reward harus angka positif!');
                    return;
                }
                
                const child = this.children[id];
                this.db.ref('children/' + id + '/dailyTarget').set(newTarget);
                this.db.ref('children/' + id + '/rewardAmount').set(newReward);
                
                this.addHistory(child.name + ': Update target ' + newTarget + ' menit, reward Rp ' + newReward.toLocaleString('id-ID'), 'settings', id);
                
                alert('Pengaturan berhasil diupdate!');
                this.closeModal();
                setTimeout(() => this.showChildDetail(id), 100);
            },

            closeModal() {
                document.getElementById('childDetailModal').style.display = 'none';
            },

            showAddTimeForm(id) {
                const minutes = prompt('Tambah berapa menit?');
                if (minutes && !isNaN(minutes)) {
                    this.updateTime(id, parseInt(minutes));
                    this.closeModal();
                    setTimeout(() => this.showChildDetail(id), 100);
                }
            },

            showAddMoneyForm(id) {
                const amount = prompt('Tambah berapa rupiah?');
                if (amount && !isNaN(amount)) {
                    const note = prompt('Catatan (opsional):') || 'Deposit';
                    this.updateMoney(id, parseInt(amount), 'deposit', note);
                    this.closeModal();
                    setTimeout(() => this.showChildDetail(id), 100);
                }
            },

            showSpendMoneyForm(id) {
                const child = this.children[id];
                const amount = prompt('Belanja berapa rupiah?');
                if (amount && !isNaN(amount)) {
                    const intAmount = parseInt(amount);
                    if (intAmount > (child.money || 0)) {
                        alert('Saldo tidak cukup!');
                        return;
                    }
                    const category = prompt('Kategori (jajan/mainan/buku/lainnya):') || 'lainnya';
                    const note = prompt('Untuk beli apa?') || '';
                    this.updateMoney(id, -intAmount, category, note);
                    this.closeModal();
                    setTimeout(() => this.showChildDetail(id), 100);
                }
            },

            resetDailyTime(id) {
                const child = this.children[id];
                if (confirm('Reset waktu ' + child.name + ' ke 0?')) {
                    this.db.ref('children/' + id + '/minutes').set(0);
                    this.addHistory(child.name + ': Reset waktu harian', 'reset', id);
                    this.closeModal();
                }
            },

            formatTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return hours > 0 ? hours + 'j ' + mins + 'm' : mins + 'm';
            },

            formatMoney(amount) {
                return 'Rp ' + amount.toLocaleString('id-ID');
            },

            formatDate(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'Baru saja';
                if (diff < 3600000) return Math.floor(diff / 60000) + ' menit lalu';
                if (diff < 86400000) return Math.floor(diff / 3600000) + ' jam lalu';
                
                return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            },

            renderDashboard() {
                const container = document.getElementById('dashboardContent');
                const childrenArray = Object.values(this.children);
                
                if (childrenArray.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-400">
                            <p class="text-xl mb-4">üë∂ Belum ada data anak</p>
                            <button onclick="app.switchTab('manage')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 font-semibold">
                                ‚ûï Tambah Anak Pertama
                            </button>
                        </div>
                    `;
                    return;
                }

                const totalTime = childrenArray.reduce((sum, c) => sum + (c.minutes || 0), 0);
                const totalMoney = childrenArray.reduce((sum, c) => sum + (c.money || 0), 0);

                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-white rounded-2xl shadow-lg p-5 text-center">
                            <div class="text-3xl mb-2">‚è∞</div>
                            <div class="text-2xl font-bold text-indigo-600">${this.formatTime(totalTime)}</div>
                            <div class="text-sm text-gray-600">Total Waktu</div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-5 text-center">
                            <div class="text-3xl mb-2">üí∞</div>
                            <div class="text-2xl font-bold text-green-600">${this.formatMoney(totalMoney)}</div>
                            <div class="text-sm text-gray-600">Total Saldo</div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        ${childrenArray.map(child => {
                            const progress = Math.min(100, ((child.minutes || 0) / (child.dailyTarget || 60)) * 100);
                            return `
                                <div class="bg-white rounded-2xl shadow-lg p-5 cursor-pointer hover:shadow-xl transition" onclick="app.showChildDetail(${child.id})">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style="background: ${child.color}20;">
                                                üë∂
                                            </div>
                                            <div>
                                                <h3 class="text-xl font-bold" style="color: ${child.color}">${child.name}</h3>
                                                <p class="text-xs text-gray-500">Target: ${child.dailyTarget || 60} menit/hari</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-indigo-600">${this.formatTime(child.minutes || 0)}</div>
                                            <div class="text-sm font-semibold text-green-600">${this.formatMoney(child.money || 0)}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                        <div class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                                    </div>
                                    <p class="text-xs text-gray-600">${Math.floor(progress)}% dari target harian</p>

                                    ${(child.badges || []).length > 0 ? `
                                        <div class="mt-3 flex gap-1 flex-wrap">
                                            ${(child.badges || []).slice(0, 3).map(badge => `
                                                <span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">${badge}</span>
                                            `).join('')}
                                            ${(child.badges || []).length > 3 ? `<span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full">+${(child.badges || []).length - 3}</span>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-5 mt-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">üìú Aktivitas Terbaru</h3>
                            <button onclick="app.switchTab('history')" class="text-sm text-indigo-600 hover:text-indigo-700">
                                Lihat Semua ‚Üí
                            </button>
                        </div>
                        <div class="space-y-2">
                            ${this.history.slice(0, 5).map(h => {
                                const child = this.children[h.childId];
                                const childName = child ? child.name : 'Unknown';
                                return `
                                    <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-lg">
                                        <span class="text-gray-700">${h.description}</span>
                                        <span class="text-gray-400 text-xs">${this.formatDate(h.timestamp)}</span>
                                    </div>
                                `;
                            }).join('') || '<p class="text-gray-400 text-sm text-center py-4">Belum ada aktivitas</p>'}
                        </div>
                    </div>
                `;
            },

            renderManage() {
                const container = document.getElementById('childrenManageList');
                const childrenArray = Object.values(this.children);
                
                if (childrenArray.length === 0) {
                    container.innerHTML = '<div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-400">Tambahkan anak pertama di atas</div>';
                    return;
                }

                container.innerHTML = childrenArray.map(child => `
                    <div class="bg-white rounded-2xl shadow-lg p-5 mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold" style="color: ${child.color}">${child.name}</h3>
                            <button onclick="app.removeChild(${child.id})" class="text-red-500 hover:text-red-700">
                                üóëÔ∏è Hapus
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="p-3 rounded-xl text-center" style="background: ${child.color}20; color: ${child.color}">
                                <div class="text-xs opacity-80">Waktu</div>
                                <div class="text-xl font-bold">${this.formatTime(child.minutes || 0)}</div>
                            </div>
                            <div class="p-3 bg-green-50 rounded-xl text-center text-green-700">
                                <div class="text-xs opacity-80">Saldo</div>
                                <div class="text-xl font-bold">${this.formatMoney(child.money || 0)}</div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-600 block mb-1">‚è∞ Kelola Waktu</label>
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <button onclick="app.updateTime(${child.id}, 5)" class="bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-bold">+5</button>
                                    <button onclick="app.updateTime(${child.id}, 15)" class="bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-bold">+15</button>
                                    <button onclick="app.updateTime(${child.id}, 30)" class="bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-bold">+30</button>
                                </div>
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <button onclick="app.updateTime(${child.id}, -5)" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 font-bold">-5</button>
                                    <button onclick="app.updateTime(${child.id}, -15)" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 font-bold">-15</button>
                                    <button onclick="app.updateTime(${child.id}, -30)" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 font-bold">-30</button>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <button onclick="app.updateTimeManual(${child.id}, false)" 
                                        class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-bold text-lg">‚àí</button>
                                    <input type="number" id="manual-time-${child.id}" placeholder="Menit..." min="0"
                                        class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-center text-lg font-semibold focus:outline-none focus:border-indigo-500">
                                    <button onclick="app.updateTimeManual(${child.id}, true)" 
                                        class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-bold text-lg">+</button>
                                </div>
                            </div>

                            <div>
                                <label class="text-sm text-gray-600 block mb-1">üí∞ Kelola Uang</label>
                                <div class="grid grid-cols-4 gap-2 mb-2">
                                    <button onclick="app.updateMoney(${child.id}, 1000)" class="bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-bold text-xs">+1K</button>
                                    <button onclick="app.updateMoney(${child.id}, 5000)" class="bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-bold text-xs">+5K</button>
                                    <button onclick="app.updateMoney(${child.id}, 10000)" class="bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-bold text-xs">+10K</button>
                                    <button onclick="app.updateMoney(${child.id}, 20000)" class="bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 font-bold text-xs">+20K</button>
                                </div>
                                <div class="grid grid-cols-4 gap-2 mb-2">
                                    <button onclick="app.updateMoney(${child.id}, -1000)" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 font-bold text-xs">-1K</button>
                                    <button onclick="app.updateMoney(${child.id}, -5000)" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 font-bold text-xs">-5K</button>
                                    <button onclick="app.updateMoney(${child.id}, -10000)" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 font-bold text-xs">-10K</button>
                                    <button onclick="app.updateMoney(${child.id}, -20000)" class="bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 font-bold text-xs">-20K</button>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <button onclick="app.updateMoneyManual(${child.id}, false)" 
                                        class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-bold text-lg">‚àí</button>
                                    <input type="number" id="manual-money-${child.id}" placeholder="Rupiah..." min="0"
                                        class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-center text-lg font-semibold focus:outline-none focus:border-indigo-500">
                                    <button onclick="app.updateMoneyManual(${child.id}, true)" 
                                        class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-bold text-lg">+</button>
                                </div>
                            </div>

                            <div class="pt-3 border-t-2 border-gray-100">
                                <label class="text-sm text-gray-600 block mb-1">‚öôÔ∏è Pengaturan Target & Reward</label>
                                
                                <div class="mb-3">
                                    <label class="text-xs text-gray-500 block mb-1">Target Waktu Harian (menit)</label>
                                    <div class="flex gap-2 items-center">
                                        <button onclick="app.adjustTarget(${child.id}, -5)" 
                                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-bold">-5</button>
                                        <button onclick="app.adjustTarget(${child.id}, -10)" 
                                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-bold">-10</button>
                                        <input type="number" id="manage-target-${child.id}" value="${child.dailyTarget || 60}"
                                            class="flex-1 px-3 py-2 border-2 border-indigo-300 rounded-lg text-center font-bold text-lg focus:outline-none focus:border-indigo-500" min="5">
                                        <button onclick="app.adjustTarget(${child.id}, 5)" 
                                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-bold">+5</button>
                                        <button onclick="app.adjustTarget(${child.id}, 10)" 
                                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-bold">+10</button>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <label class="text-xs text-gray-500 block mb-1">Reward per Target (Rp)</label>
                                    <div class="flex gap-2 items-center">
                                        <button onclick="app.adjustReward(${child.id}, -1000)" 
                                            class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 font-bold text-sm">-1K</button>
                                        <button onclick="app.adjustReward(${child.id}, -5000)" 
                                            class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 font-bold text-sm">-5K</button>
                                        <input type="number" id="manage-reward-${child.id}" value="${child.rewardAmount || 5000}"
                                            class="flex-1 px-3 py-2 border-2 border-indigo-300 rounded-lg text-center font-bold text-lg focus:outline-none focus:border-indigo-500" min="0" step="1000">
                                        <button onclick="app.adjustReward(${child.id}, 1000)" 
                                            class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 font-bold text-sm">+1K</button>
                                        <button onclick="app.adjustReward(${child.id}, 5000)" 
                                            class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 font-bold text-sm">+5K</button>
                                    </div>
                                </div>
                                <button onclick="app.saveTargetRewardManual(${child.id})" 
                                    class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 font-semibold text-sm">
                                    üíæ Simpan Perubahan Manual
                                </button>
                            </div>

                            <button onclick="app.showChildDetail(${child.id})" class="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 font-semibold">
                                üìä Lihat Detail & Statistik
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            updateChildSettingsFromManage(id) {
                const newTarget = parseInt(document.getElementById('manage-target-' + id).value);
                const newReward = parseInt(document.getElementById('manage-reward-' + id).value);
                
                if (isNaN(newTarget) || newTarget < 0) {
                    alert('Target harus angka positif!');
                    return;
                }
                
                if (isNaN(newReward) || newReward < 0) {
                    alert('Reward harus angka positif!');
                    return;
                }
                
                const child = this.children[id];
                this.db.ref('children/' + id + '/dailyTarget').set(newTarget);
                this.db.ref('children/' + id + '/rewardAmount').set(newReward);
                
                this.addHistory(child.name + ': Update target ' + newTarget + ' menit, reward Rp ' + newReward.toLocaleString('id-ID'), 'settings', id);
                
                alert('Pengaturan ' + child.name + ' berhasil diupdate!');
                this.renderManage();
            },

            adjustTarget(id, amount) {
                const child = this.children[id];
                const currentTarget = child.dailyTarget || 60;
                const newTarget = Math.max(5, currentTarget + amount);
                
                this.db.ref('children/' + id + '/dailyTarget').set(newTarget);
                this.addHistory(child.name + ': Target diubah jadi ' + newTarget + ' menit', 'settings', id);
            },

            adjustReward(id, amount) {
                const child = this.children[id];
                const currentReward = child.rewardAmount || 5000;
                const newReward = Math.max(0, currentReward + amount);
                
                this.db.ref('children/' + id + '/rewardAmount').set(newReward);
                this.addHistory(child.name + ': Reward diubah jadi Rp ' + newReward.toLocaleString('id-ID'), 'settings', id);
            },

            saveTargetRewardManual(id) {
                const targetInput = document.getElementById('manage-target-' + id);
                const rewardInput = document.getElementById('manage-reward-' + id);
                
                const newTarget = parseInt(targetInput.value);
                const newReward = parseInt(rewardInput.value);
                
                if (isNaN(newTarget) || newTarget < 5) {
                    alert('Target minimal 5 menit!');
                    return;
                }
                
                if (isNaN(newReward) || newReward < 0) {
                    alert('Reward harus angka positif!');
                    return;
                }
                
                const child = this.children[id];
                this.db.ref('children/' + id + '/dailyTarget').set(newTarget);
                this.db.ref('children/' + id + '/rewardAmount').set(newReward);
                
                this.addHistory(child.name + ': Target diubah jadi ' + newTarget + ' menit, Reward Rp ' + newReward.toLocaleString('id-ID'), 'settings', id);
                
                alert('‚úÖ Target & Reward berhasil disimpan!');
            },

            renderHistory() {
                const container = document.getElementById('historyList');
                
                if (this.history.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada riwayat transaksi</p>';
                    return;
                }

                const groupedByDate = {};
                this.history.forEach(h => {
                    const date = new Date(h.timestamp).toLocaleDateString('id-ID', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    if (!groupedByDate[date]) groupedByDate[date] = [];
                    groupedByDate[date].push(h);
                });

                container.innerHTML = Object.entries(groupedByDate).map(([date, items]) => `
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-700 mb-2">${date}</h4>
                        <div class="space-y-2">
                            ${items.map(h => {
                                let icon = 'üìù';
                                let color = 'text-gray-700';
                                if (h.type === 'time') {
                                    icon = h.amount > 0 ? '‚è∞‚ûï' : '‚è∞‚ûñ';
                                    color = h.amount > 0 ? 'text-green-600' : 'text-red-600';
                                } else if (h.type === 'money') {
                                    icon = h.amount > 0 ? 'üí∞‚ûï' : 'üí∏';
                                    color = h.amount > 0 ? 'text-green-600' : 'text-red-600';
                                } else if (h.type === 'add_child') {
                                    icon = 'üë∂';
                                    color = 'text-blue-600';
                                }
                                
                                return `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xl">${icon}</span>
                                            <span class="${color} text-sm">${h.description}</span>
                                        </div>
                                        <span class="text-xs text-gray-400">${new Date(h.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
            },

            exportAllData() {
                const data = {
                    children: this.children,
                    history: this.history,
                    settings: this.settings,
                    exportDate: Date.now()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'waktu-anak-backup-' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
                URL.revokeObjectURL(url);
                
                alert('Data berhasil di-export!');
            },

            resetAllData() {
                if (!confirm('PERHATIAN: Ini akan menghapus SEMUA data termasuk anak, waktu, uang, dan riwayat. Yakin?')) return;
                if (!confirm('Yakin 100%? Data tidak bisa dikembalikan!')) return;

                this.db.ref('children').remove();
                this.db.ref('history').remove();
                alert('Semua data berhasil dihapus!');
            },

            resetFirebaseConfig() {
                if (confirm('Reset konfigurasi Firebase? Anda perlu setup ulang.')) {
                    localStorage.removeItem('firebaseConfig');
                    location.reload();
                }
            }
        };

        // Close modal when clicking outside
        document.getElementById('childDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                app.closeModal();
            }
        });

        app.init();
    </script>
</body>
</html>
